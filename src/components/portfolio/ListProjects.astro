---
import Project from "./Project.astro";
import { Icon } from "astro-icon/components";
import { Search } from "@lucide/astro";

const allPosts = await Astro.glob("../../pages/portfolio/projects/*.md");
// Sort by descending date (most recent first)
allPosts.sort(
  (a, b) =>
    new Date(b.frontmatter.pubDate).getTime() -
    new Date(a.frontmatter.pubDate).getTime(),
);

// Extract unique categories/tags for filter (simplified to top languages for now)
const allTags = [...new Set(allPosts.flatMap(post => post.frontmatter.languages || []))];
const categories = ["All", "C++", "Graphics", "Web", "Tools"]; // Custom categories for the UI feel
---

<section class="relative w-full max-w-7xl mx-auto my-12 border border-white/10 bg-zinc-950 rounded-lg overflow-hidden shadow-2xl flex flex-col h-[85vh]">
  
  <!-- Toolbar (Header) -->
  <div class="sticky top-0 z-40 flex flex-col md:flex-row items-center justify-between p-4 gap-4 border-b border-white/5 bg-zinc-950/90 backdrop-blur-md">
    
    <!-- Search Input -->
    <div class="relative w-full md:w-96 group">
      <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-zinc-500 group-focus-within:text-cyan-400 transition-colors">
        <span class="font-mono text-lg">></span>
      </div>
      <input 
        type="text" 
        id="projectSearch"
        class="block w-full p-2 pl-8 text-sm font-mono text-zinc-300 bg-zinc-900 border border-zinc-800 rounded-sm focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 placeholder-zinc-600 outline-none transition-all" 
        placeholder="Search modules..." 
        autocomplete="off"
      >
    </div>

    <!-- Filter Tabs -->
    <div class="flex items-center gap-1 overflow-x-auto w-full md:w-auto no-scrollbar" id="filterTabs">
      <button 
        class="filter-tab active px-4 py-1.5 text-xs font-medium text-zinc-400 hover:text-white hover:bg-white/5 rounded-sm transition-all border border-transparent data-[active=true]:text-white data-[active=true]:bg-white/10 data-[active=true]:border-white/10 data-[active=true]:shadow-[0_0_10px_rgba(255,255,255,0.1)]"
        data-category="All"
      >
        ALL
      </button>
      {categories.filter(c => c !== "All").map(category => (
        <button 
          class="filter-tab px-4 py-1.5 text-xs font-medium text-zinc-400 hover:text-white hover:bg-white/5 rounded-sm transition-all border border-transparent data-[active=true]:text-white data-[active=true]:bg-white/10 data-[active=true]:border-white/10 data-[active=true]:shadow-[0_0_10px_rgba(255,255,255,0.1)]"
          data-category={category}
        >
          {category.toUpperCase()}
        </button>
      ))}
    </div>
  </div>

  <!-- Content Grid (Scrollable Area) -->
  <div class="flex-1 overflow-y-auto bg-zinc-950 relative scroll-smooth" id="projectsGrid">
    <!-- Grid Background Pattern -->
    <div class="relative grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 p-6 gap-6 inset-0 z-10 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:var(--grid-size)_var(--grid-size)]">
      {
        allPosts.map((post) => {
          const tags = post.frontmatter.languages || [];
          const tagsString = tags.join(" ").toLowerCase();
          const titleString = post.frontmatter.title.toLowerCase();
          
          // Simple category mapping logic for demo purposes
          let categoryClass = "category-all";
          if (tags.some((t: string) => t.includes("C++") || t.includes("Rust"))) categoryClass += " category-c++";
          if (tags.some((t: string) => t.includes("GL") || t.includes("Vulkan") || t.includes("Graphics"))) categoryClass += " category-graphics";
          if (tags.some((t: string) => t.includes("Web") || t.includes("React") || t.includes("Astro"))) categoryClass += " category-web";
          if (tags.some((t: string) => t.includes("Tool") || t.includes("Python"))) categoryClass += " category-tools";

          return (
            <div 
              class={`project-item ${categoryClass}`}
              data-title={titleString}
              data-tags={tagsString}
            >
              <Project
                url={post.url}
                title={post.frontmatter.title}
                description={post.frontmatter.description}
                date={post.frontmatter.pubDate}
                languages={tags}
                image={post.frontmatter.image}
              />
            </div>
          );
        })
      }
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="hidden flex-col items-center justify-center h-full text-zinc-500">
      <Search class="w-12 h-12 mb-4 opacity-20" />
      <p class="font-mono text-sm">NO MODULES FOUND</p>
    </div>
  </div>

  <!-- Status Bar (Footer) -->
  <div class="flex items-center justify-between px-4 py-2 bg-zinc-950 border-t border-white/5 text-[10px] font-mono text-zinc-600 uppercase tracking-wider select-none">
    <div class="flex items-center gap-4">
      <span class="flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-green-500/50 animate-pulse"></span>
        INDEXING COMPLETE
      </span>
      <span id="itemCount">{allPosts.length} ITEMS FOUND</span>
    </div>
    <div>
      VIEWPORT: READY
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('projectSearch') as HTMLInputElement;
    const filterTabs = document.querySelectorAll('.filter-tab');
    const projectItems = document.querySelectorAll('.project-item');
    const itemCountLabel = document.getElementById('itemCount');
    const emptyState = document.getElementById('emptyState');
    
    let currentCategory = 'All';
    let currentSearch = '';

    function filterProjects() {
      let visibleCount = 0;

      projectItems.forEach(item => {
        const title = item.getAttribute('data-title') || '';
        const tags = item.getAttribute('data-tags') || '';
        const itemElement = item as HTMLElement;
        
        const matchesSearch = title.includes(currentSearch) || tags.includes(currentSearch);
        const matchesCategory = currentCategory === 'All' || item.classList.contains(`category-${currentCategory.toLowerCase()}`);

        if (matchesSearch && matchesCategory) {
          itemElement.style.display = '';
          visibleCount++;
        } else {
          itemElement.style.display = 'none';
        }
      });

      // Update UI
      if (itemCountLabel) itemCountLabel.textContent = `${visibleCount} ITEMS FOUND`;
      
      if (emptyState) {
        if (visibleCount === 0) {
          emptyState.classList.remove('hidden');
          emptyState.classList.add('flex');
        } else {
          emptyState.classList.add('hidden');
          emptyState.classList.remove('flex');
        }
      }
    }

    // Search Listener
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
      filterProjects();
    });

    // Tab Listener
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Update active state
        filterTabs.forEach(t => t.removeAttribute('data-active'));
        tab.setAttribute('data-active', 'true');
        
        currentCategory = tab.getAttribute('data-category') || 'All';
        filterProjects();
      });
    });

    // Set initial active tab
    const initialTab = document.querySelector('.filter-tab[data-category="All"]');
    if (initialTab) initialTab.setAttribute('data-active', 'true');
  });
</script>

<style>
  /* Hide scrollbar for tabs */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
