---
// src/components/mdx/Gallery.astro
import {Image} from "astro:assets";
import SkeletonImage from "./SkeletonImage.astro";

interface Props {
  images: {
    src: string;
    alt: string;
  }[];
}

const {images} = Astro.props;

const getClassForIndex = (index: number) => {
  const i = index % 6;

  switch (i) {
    case 0:
      return "md:col-span-2 md:row-span-2"; // (Hero)
    case 3:
      return "md:col-span-2"; // Panorama
    case 4:
      return "md:col-span-1 md:row-span-2"; // (Portrait)
    default:
      return ""; // Standard (1x1)
  }
};
---

<div class="not-prose my-12">
  <div class="grid grid-cols-1 md:grid-cols-3 auto-rows-[200px] gap-4" style="grid-auto-flow: dense;">

    {images.map((img, index) => (
            <button
                    class={`
          group relative w-full h-full rounded-xl overflow-hidden border border-white/10 bg-zinc-900 
          cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-cyan-500
          transition-all duration-500 ease-out hover:border-cyan-500/50 hover:shadow-2xl hover:shadow-cyan-900/20
          ${getClassForIndex(index)}
        `}
                    data-src={img.src}
                    data-alt={img.alt}
                    onclick="openLightbox(this)"
                    aria-label={`View image: ${img.alt}`}
            >
              <SkeletonImage
                      src={img.src}
                      alt={img.alt}
                      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                      loading="lazy"
              >
                <div class="absolute inset-0 bg-gradient-to-t from-zinc-950/50 to-transparent pointer-events-none z-20"></div>
              </SkeletonImage>

              <div class="absolute inset-0 bg-zinc-950/0 group-hover:bg-zinc-950/30 transition-colors duration-300"></div>

              <div class="absolute bottom-3 left-3 opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300">
                <div class="flex items-center gap-2 bg-zinc-950/90 backdrop-blur-md border border-white/10 px-2 py-1 rounded text-[10px] font-mono text-cyan-400 shadow-lg">
                  <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  <span class="truncate max-w-[150px]">> IMG_{index.toString().padStart(3, '0')}</span>
                </div>
              </div>
            </button>
    ))}
  </div>
</div>

<div id="lightbox"
     class="fixed inset-0 z-[100] bg-zinc-950/95 backdrop-blur-xl hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-4">
  <button onclick="closeLightbox()"
          class="absolute top-6 right-6 text-zinc-400 hover:text-white transition-colors p-2 z-50 bg-zinc-900/50 rounded-full border border-white/10">
    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>
  <img id="lightbox-img" src="" alt=""
       class="max-w-full max-h-[90vh] rounded-lg shadow-2xl shadow-black border border-white/10 transform scale-95 transition-transform duration-300"/>
  <p id="lightbox-caption"
     class="absolute bottom-6 text-zinc-400 font-mono text-xs bg-zinc-950/90 border border-white/10 px-4 py-2 rounded-full backdrop-blur-md"></p>
</div>

<script is:inline>
  function openLightbox(btn) {
    const lightbox = document.getElementById('lightbox');
    const img = document.getElementById('lightbox-img');
    const caption = document.getElementById('lightbox-caption');
    const body = document.body;

    if (!lightbox || !img || !btn) return;

    // CAMBIO 4: Leemos los datos de forma segura desde el dataset
    // Esto maneja comillas, espacios y caracteres raros automáticamente.
    const src = btn.dataset.src;
    const alt = btn.dataset.alt;

    img.src = src;
    img.alt = alt;
    caption.innerText = alt;

    // Resto de la lógica igual...
    lightbox.classList.remove('hidden');
    setTimeout(() => {
      lightbox.classList.remove('opacity-0');
      img.classList.remove('scale-95');
    }, 10);
    body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    const img = document.getElementById('lightbox-img');
    const body = document.body;
    if (!lightbox) return;
    lightbox.classList.add('opacity-0');
    img.classList.add('scale-95');
    setTimeout(() => {
      lightbox.classList.add('hidden');
      img.src = '';
      body.style.overflow = '';
    }, 300);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });
  document.getElementById('lightbox')?.addEventListener('click', (e) => {
    if (e.target.id === 'lightbox') closeLightbox();
  });
</script>